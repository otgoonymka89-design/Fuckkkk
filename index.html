<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixed AR Avatar</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.0/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
</head>

<body style="margin: 0; overflow: hidden;">
    <a-scene mindar-image="imageTargetSrc: ; autoStart: true; uiLoading: no; uiScanning: no;" 
             embedded color-space="sRGB" 
             renderer="colorManagement: true, physicallyCorrectLights: true" 
             vr-mode-ui="enabled: false" 
             device-orientation-permission-ui="enabled: false">
        
        <a-assets>
            <audio id="voice" src="voice.mp3" preload="auto"></audio>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity id="avatar-container" position="0 -1.5 -3">
            <a-entity id="avatar"
                gltf-model="avatar.glb"
                scale="1.5 1.5 1.5"
                rotation="0 0 0"
                animation-mixer="clip: Idle; loop: repeat; timeScale: 1"
                viseme-lipsync>
            </a-entity>
        </a-entity>

        <a-light type="ambient" intensity="0.8"></a-light>
        <a-light type="directional" position="1 2 2" intensity="1"></a-light>
    </a-scene>

<script>
AFRAME.registerComponent('viseme-lipsync', {
    init() {
        const audio = document.querySelector('#voice');
        let ctx, analyser, data;
        
        let mesh, dict, infl;
        this.el.addEventListener('model-loaded', () => {
            // Моделийг ачаалахад бүх хэсгийг шалгаж Morph Target-ийг олно
            this.el.getObject3D('mesh').traverse(n => {
                if (n.morphTargetDictionary && n.morphTargetInfluences) {
                    mesh = n;
                    dict = n.morphTargetDictionary;
                    infl = n.morphTargetInfluences;
                }
            });
        });

        const V = name => (dict && dict[name] !== undefined) ? dict[name] : -1;

        const vis = {
            aa: () => V('viseme_aa'),
            ee: () => V('viseme_E'),
            ii: () => V('viseme_I'),
            oo: () => V('viseme_O'),
            uu: () => V('viseme_U'),
            sil: () => V('viseme_sil'),
            open: () => V('mouthOpen')
        };

        const smooth = (i, v) => { if (i >= 0) infl[i] = (infl[i] || 0) * 0.4 + v * 0.6; };

        const animate = () => {
            if (!analyser) return;
            analyser.getByteFrequencyData(data);
            
            const avg = (a, b) => {
                let s = 0, c = 0;
                for (let i = a; i < b && i < data.length; i++) { s += data[i]; c++; }
                return (s / c) / 255;
            };

            const low = avg(0, 200);
            const mid = avg(200, 1000);
            const high = avg(1000, 3000);

            // Бүх morph-ийг 0 болгож шинэчлэх
            Object.values(vis).forEach(f => { 
                const i = f(); 
                if (i >= 0) infl[i] = 0; 
            });

            // Дууны давтамжаар амыг хөдөлгөх
            if (low > 0.01) {
                smooth(vis.aa(), Math.min(1, low * 3));
                smooth(vis.open(), Math.min(1, low * 2.5));
            }
            if (mid > 0.01) {
                smooth(vis.ee(), Math.min(1, mid * 2));
                smooth(vis.ii(), Math.min(1, mid * 2));
            }

            requestAnimationFrame(animate);
        };

        // Дэлгэц дээр нэг удаа дарахад "Idle" анимэйшн болон дуу эхэлнэ
        window.addEventListener('click', async () => {
            if (!ctx) {
                ctx = new (window.AudioContext || window.webkitAudioContext)();
                const src = ctx.createMediaElementSource(audio);
                analyser = ctx.createAnalyser();
                analyser.fftSize = 512;
                src.connect(analyser);
                analyser.connect(ctx.destination);
                data = new Uint8Array(analyser.frequencyBinCount);
            }
            await ctx.resume();
            audio.play();
            animate();
        }, { once: true });
    }
});
</script>
</body>
</html>
