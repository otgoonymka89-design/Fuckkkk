<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>AR Talking Human</title>

<script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
</head>

<body style="margin:0; overflow:hidden;">
<a-scene embedded arjs="sourceType: webcam;">

<a-assets>
  <audio id="voice" src="voice.mp3"></audio>
  <a-asset-item id="human" src="avatar.glb"></a-asset-item>
</a-assets>

<a-marker preset="hiro">
  <a-entity
    id="model"
    gltf-model="#human"
    scale="1 1 1"
    position="0 0 0"
    lipsync>
  </a-entity>
</a-marker>

<a-entity camera></a-entity>
</a-scene>

<script>
AFRAME.registerComponent('lipsync', {
  init() {
    const audio = document.querySelector('#voice');
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const src = ctx.createMediaElementSource(audio);
    const analyser = ctx.createAnalyser();
    src.connect(analyser);
    analyser.connect(ctx.destination);

    let mouth;
    this.el.addEventListener('model-loaded',()=>{
      this.el.getObject3D('mesh').traverse(o=>{
        if(o.morphTargetDictionary?.mouthOpen!==undefined){
          mouth = o;
        }
      });
    });

    const data = new Uint8Array(analyser.frequencyBinCount);

    const loop=()=>{
      if(mouth){
        analyser.getByteFrequencyData(data);
        const v = data[10]/255;
        mouth.morphTargetInfluences[mouth.morphTargetDictionary.mouthOpen]=v;
      }
      requestAnimationFrame(loop);
    };

    window.addEventListener('click',async()=>{
      await ctx.resume();
      audio.play();
      loop();
    },{once:true});
  }
});
</script>
</body>
</html>
